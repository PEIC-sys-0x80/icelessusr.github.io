# vmstat指令

#資訊科技 #終端指令 #網路引用資料 #linux/unix指令 #linux

[參考資料](https://kezhi.tech/linux-command/c/vmstat.html)

vmstat指令的含意為顯示虛擬記憶體狀態 ("Virtual Memory Statistics")，但其功能遠不止於此。它可以報告與**處理程序(process)**、**記憶體(memory)**、**分頁(paging)**、**區塊IO(block I/O)**、**中斷(interrupts)**、**上下文切換(context switches)** 和 **CPU活動**有關的統計資訊，並提供系統整體執行狀態的即時快照。這對系統管理員來說是一項非常有用的診斷工具，可用於分析系統瓶頸與效能問題。

vmstat通常用於：

* 監控系統資源使用狀態
* 分析記憶體不足或交換區使用頻繁的情形
* 偵測CPU或I/O資源壅塞
* 與其他工具（如top、iotop、sar）搭配使用做更深入分析

### 語法

```
vmstat [選項] [事件間隔] [次數]
```

### 選項

* `-a`: 顯示活動內頁（active/inactive memory）
* `-f`: 顯示系統啟動以來創建的處理程序總數
* `-m`: 顯示slab allocator使用狀況（可幫助追蹤記憶體碎片化問題）
* `-n`: 僅在輸出開頭列印一次欄位標題
* `-s`: 以條列方式顯示系統統計資訊（類似`vmstat -a`的累積視角）
* `-d`: 顯示磁碟裝置的I/O統計
* `-p partition`: 顯示指定磁碟分區的I/O統計
* `-S [k|K|m|M]`: 指定輸出單位（例如 k 為千位元組，m 為百萬位元組）
* `-w`: 寬格式輸出欄位，使長欄位數值不被截斷

### 參數

* **事件間隔** (秒)：輸出更新的時間間隔。若未指定，預設只輸出一次。
* **次數**：總共輸出的次數，配合事件間隔使用。

> 例如 `vmstat 5 3` 表示每5秒輸出一次，總共輸出3次。

---

### 實例

```
vmstat 3
```

輸出說明如下：

```
procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 0  0    320  42188 167332 1534368    0    0     4     7    1    0  0  0 99  0  0
```

#### 字段說明：

---

#### **Procs（處理程序）**

* `r`：可執行（runnable）狀態的處理程序數量，即正在等待CPU的處理程序數。長期大於1表示CPU資源可能不足。
* `b`：不可中斷睡眠（通常等待I/O）的處理程序數。過多的`b`值可能暗示I/O瓶頸。

---

#### **Memory（記憶體）**

* `swpd`：已使用的虛擬記憶體大小（單位KB）。若此值持續上升，表示系統記憶體壓力大。
* `free`：空閒的物理記憶體。
* `buff`：作為快取區塊裝置用的記憶體，通常是與檔案系統metadata相關的資料。
* `cache`：作為檔案快取的記憶體，當頻繁存取的檔案都能被快取命中，系統I/O效能會更好。

---

#### **Swap（交換區）**

* `si`：每秒從swap讀取至記憶體的KB數（swap in）。
* `so`：每秒從記憶體寫入swap的KB數（swap out）。

> 長期非零的`si`與`so`通常表示記憶體不足，會造成效能下降，應考慮加裝記憶體或調整程式使用。

---

#### **IO（磁碟輸入輸出）**

* `bi`：每秒從區塊裝置（磁碟）讀取的區塊數（以1KB為單位）。
* `bo`：每秒寫入區塊裝置的區塊數。

> 高`bi`或`bo`可能表示磁碟I/O壓力大，導致CPU等待I/O完成。

---

#### **System（系統內部行為）**

* `in`：每秒的中斷次數，包括硬體與軟體中斷。
* `cs`：每秒上下文切換次數。若此值過高，表示CPU在不同程序間切換過於頻繁，可能導致效能下降。

---

#### **CPU（CPU使用狀況）**

* `us`：使用者層級的CPU時間百分比。表示應用程式使用CPU的比例。
* `sy`：核心層級的CPU時間百分比。表示核心或驅動程式使用CPU的比例。
* `id`：CPU空閒百分比。若長期接近0，表示CPU已接近滿載。
* `wa`：CPU等待I/O完成的時間百分比。高`wa`值通常與磁碟I/O壅塞有關。
* `st`：虛擬機環境下，CPU被偷走的百分比（stolen time）。主機資源被其他VM使用。

---

### 進階用法與實務應用

1. **持續監控系統**

   ```
   vmstat 1
   ```

   每秒輸出一次，持續監控系統資源，搭配其他工具可快速定位問題。

2. **搭配`watch`動態查看**

   ```
   watch -n 1 vmstat
   ```

   每秒更新vmstat輸出，更直觀觀察變化。

3. **排除記憶體瓶頸**
   觀察`free`、`si`、`so`欄位，若swap頻繁啟用，表示記憶體不足，可透過`top`搭配查看是誰佔用太多記憶體。

4. **偵測磁碟I/O瓶頸**
   若`bi`或`bo`長期高、`wa`值大，表示磁碟可能有問題，可搭配`iostat`、`iotop`進一步分析。

5. **整合腳本自動記錄**
   vmstat可結合`cron`或shell script定時記錄系統狀況，方便日後分析：

   ```bash
   vmstat 5 12 >> /var/log/vmstat.log
   ```

---

`vmstat`是一個輕量、實用且即時的效能監控工具，特別適合快速診斷Linux/Unix系統中的瓶頸。雖然它不能提供每個程序的詳細資料，但它能提供整體系統的健康快照。與`top`、`htop`、`iostat`、`free`等工具搭配使用，可以建立全面的效能監控流程。
